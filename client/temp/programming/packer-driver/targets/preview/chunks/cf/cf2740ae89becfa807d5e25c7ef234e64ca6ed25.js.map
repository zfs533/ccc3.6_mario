{"version":3,"sources":["file:///D:/CocosDashboard/resources/.editors/Creator/3.6.0/resources/app.asar.unpacked/modules/editor-extensions/extensions/localization-editor/static/assets/core/asset-manager-initer.ts"],"names":["AMPipeLineManager","assetManager","EDITOR","PREVIEW","pluginName","initialized","l10n","undefined","_redirectTask","redirectTask","task","input","output","i","length","item","url","isNative","newUUID","uuid","arr","split","translatedUUID","t","join","oldUUID","newURL","replace","slice","redirectLog","console","debug","config","newAsset","getAssetInfo","redirect","warn","name","initAssetManager","bind","transformPipeline","append","uninstall","index","pipes","findIndex","it","remove"],"mappings":"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","sourcesContent":["import { assetManager, AssetManager } from 'cc';\n// @ts-ignore\nimport { EDITOR, PREVIEW } from 'cc/env';\nimport type { L10nManager } from './l10n-manager';\nimport { pluginName } from './localization-global';\n\nexport default class AMPipeLineManager {\n    initialized = false;\n    l10n?: L10nManager = undefined;\n    _redirectTask: this['redirectTask'];\n    initAssetManager(l10n: L10nManager) {\n        if (!this.initialized) {\n            this.l10n = l10n;\n            this._redirectTask = this.redirectTask.bind(this);\n            assetManager.transformPipeline.append(this._redirectTask);\n            this.initialized = true;\n        }\n    }\n\n    uninstall() {\n        const index = assetManager.transformPipeline.pipes.findIndex(it => it === this._redirectTask);\n        if (index >= 0) {\n            assetManager.transformPipeline.remove(index);\n        }\n    }\n\n    redirectTask = (task: { output: AssetManager.RequestItem[]; input: AssetManager.RequestItem[]; }) => {\n        const input = (task.output = task.input);\n        for (let i = 0; i < input.length; i++) {\n            const item = input[i];\n\n            if (!item.url || !item.isNative) {\n                continue;\n            }\n\n            let newUUID = item.uuid;\n            const arr = newUUID.split('@');\n            const translatedUUID = this.l10n?.t(arr[0]) ?? arr[0];\n            arr[0] = translatedUUID;\n            newUUID = arr.join('@');\n            const oldUUID = item.uuid;\n            const newURL = item.url.replace(`${oldUUID.slice(0, 2)}/${oldUUID}`, `${newUUID.slice(0, 2)}/${newUUID}`);\n            const redirectLog = `[${pluginName}]: Change URL \"${item.url}\" for asset with UUID \"${oldUUID}\" to \"${newURL}\"`;\n            if (oldUUID === newUUID) {\n                return;\n            }\n            if (EDITOR || PREVIEW) {\n                console.debug(redirectLog);\n                item.url = newURL;\n            } else {\n                if (!item.config) {\n                    return;\n                }\n                const newAsset = item.config.getAssetInfo(newUUID);\n                if (newAsset && !newAsset.redirect) {\n                    item.url = newURL;\n                    console.debug(redirectLog);\n                } else {\n                    console.warn(`[${pluginName}]: Failed to redirect an asset with UUID \"${oldUUID}\" because the asset with UUID \"${newUUID}\" could not be found in the bundle named ${item.config.name}`);\n                }\n            }\n        }\n        return;\n    }\n}\n"]}