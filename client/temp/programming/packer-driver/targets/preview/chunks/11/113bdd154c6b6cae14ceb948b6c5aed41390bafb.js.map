{"version":3,"sources":["file:///D:/CocosDashboard/resources/.editors/Creator/3.6.0/resources/app.asar.unpacked/modules/editor-extensions/extensions/localization-editor/static/assets/core/resource-data-manager.ts"],"names":["ResourceDataManager","assetManager","settings","Settings","BUILD","EDITOR","mainName","pluginName","resourceBundlePath","resourceListPath","runtimeBundleName","readResourceList","Editor","Message","request","console","log","runtimeLoad","previewLoad","readResourceBundle","tags","editorLoad","locales","fileName","bundle","getBundle","undefined","jsonAsset","getResource","json","urlPath","fetch","e","checkBundle","bundleName","queryResult","querySettings","Category","ASSETS","find","it","Promise","resolve","loadBundle","error","resourceName","load","asset"],"mappings":"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","sourcesContent":["// @ts-ignore\nimport { BUILD, EDITOR } from 'cc/env';\nimport { AssetManager, assetManager, JsonAsset, settings, Settings } from 'cc';\nimport { ResourceBundle, ResourceList } from './l10n-options';\nimport { mainName, pluginName, resourceBundlePath, resourceListPath, runtimeBundleName } from './localization-global';\n\nexport default class ResourceDataManager {\n    async readResourceList(): Promise<ResourceList> {\n        if (EDITOR) {\n            return Editor.Message.request(mainName, 'get-resource-list');\n        } else if (BUILD) {\n            console.log(`[${pluginName}] this is build env`);\n            return this.runtimeLoad(resourceListPath);\n        } else {\n            return this.previewLoad(resourceListPath);\n        }\n    }\n\n    async readResourceBundle(tags: Intl.BCP47LanguageTag[]): Promise<ResourceBundle> {\n        if (EDITOR) {\n            return this.editorLoad(tags);\n        } else if (BUILD) {\n            return this.runtimeLoad(resourceBundlePath);\n        } else {\n            return this.previewLoad(resourceBundlePath);\n        }\n    }\n\n    /**\n     * 编辑器模式下使用\n     * @param locales\n     */\n    async editorLoad(locales: Intl.BCP47LanguageTag[]): Promise<ResourceBundle | undefined> {\n        return Editor.Message.request(mainName, 'get-resource-bundle', locales);\n    }\n\n    /**\n     * 构建后运行时使用\n     * @param fileName\n     */\n    async runtimeLoad<T>(fileName: string): Promise<T | undefined> {\n        const bundle = await this.getBundle(runtimeBundleName);\n        if (!bundle) return undefined;\n        const jsonAsset = await this.getResource(bundle, fileName);\n        if (!jsonAsset || !jsonAsset.json) return undefined;\n        return jsonAsset.json as any as T;\n    }\n\n    /**\n     * 浏览器预览使用\n     * @param urlPath\n     */\n    async previewLoad<T>(urlPath: string): Promise<T | undefined> {\n        try {\n            return await (await fetch(`${mainName}/${urlPath}`)).json() as T;\n        } catch (e) {\n            return undefined;\n        }\n    }\n\n    async checkBundle(bundleName: string): Promise<boolean> {\n        const queryResult: { bundle: string, version: string }[] | null = settings.querySettings<{ bundle: string, version: string }[]>(Settings.Category.ASSETS, 'preloadBundles');\n        const bundle = queryResult?.find((it) => it.bundle === bundleName);\n        return !!bundle;\n    }\n\n    async getBundle(bundleName: string): Promise<AssetManager.Bundle | undefined> {\n        return new Promise(resolve => {\n            assetManager.loadBundle(bundleName, (error, bundle: AssetManager.Bundle) => {\n                if (error) {\n                    resolve(undefined);\n                } else {\n                    resolve(bundle);\n                }\n            });\n        });\n    }\n\n    async getResource(bundle: AssetManager.Bundle, resourceName: string): Promise<JsonAsset | undefined> {\n        return new Promise(resolve => {\n            bundle.load(resourceName, (error, asset: JsonAsset) => {\n                if (error) {\n                    resolve(undefined);\n                } else {\n                    resolve(asset);\n                }\n            });\n        });\n    }\n}\n"]}