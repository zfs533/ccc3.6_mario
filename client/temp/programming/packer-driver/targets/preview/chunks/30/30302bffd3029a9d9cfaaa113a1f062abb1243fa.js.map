{"version":3,"sources":["file:///E:/CocosCreator/git/mario/client/assets/script/game/ui/joystick/joystick.ts"],"names":["_decorator","Component","Node","Vec3","UITransform","input","Input","KeyCode","AudioManager","clientEvent","Constant","ccclass","property","joystick","_originPos","_R","_offsetX","_isUseful","_isFinished","onLoad","_init","node","on","EventType","TOUCH_START","_touchStart","TOUCH_MOVE","_touchMove","TOUCH_END","_touchEnd","TOUCH_CANCEL","set","joystickBg","getPosition","x","y","KEY_DOWN","_onKeyDown","KEY_UP","_onKeyUp","FinishedGame","_addListener","event","CurMap","physicsStatus","touchPos","getUILocation","pos","parent","getComponent","convertToNodeSpaceAR","setPosition","radius","Math","atan2","out","len","subtract","length","xx","cos","yy","sin","joystickBar","bPos","dispatchEvent","EVENT_TYPE","Move","Stop","e","keyCode","KEY_A","KEY_D","SPACE","jump","MoveJoystick","_evtMoveJoystick","_evtFinishedGame","onDestroy","off","point","instance","playSound","Jump","undefined"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, EventTouch, Vec3, UITransform, input, Input, EventKeyboard, KeyCode, view } from 'cc';\r\nimport { AudioManager } from '../../../framework/audioManager';\r\nimport { clientEvent } from '../../../framework/clientEvent';\r\nimport { Constant } from '../../../framework/constant';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('joystick')\r\nexport class joystick extends Component {\r\n    @property(Node)\r\n    joystickBg: Node = undefined as unknown as Node;\r\n\r\n    @property(Node)\r\n    joystickBar: Node = undefined as unknown as Node;\r\n\r\n    private _originPos: Vec3 = new Vec3();\r\n\r\n    private _R: number = 100;\r\n    private _offsetX: number = 0;\r\n    private _isUseful: boolean = false;\r\n    private _isFinished: boolean = false;\r\n\r\n    onLoad() {\r\n        this._init();\r\n        this.node.on(Node.EventType.TOUCH_START, this._touchStart, this);\r\n        this.node.on(Node.EventType.TOUCH_MOVE, this._touchMove, this);\r\n        this.node.on(Node.EventType.TOUCH_END, this._touchEnd, this);\r\n        this.node.on(Node.EventType.TOUCH_CANCEL, this._touchEnd, this);\r\n        this._originPos.set(this.joystickBg.getPosition().x, this.joystickBg.getPosition().y, 0);\r\n        //键盘事件test\r\n        input.on(Input.EventType.KEY_DOWN, this._onKeyDown, this);\r\n        input.on(Input.EventType.KEY_UP, this._onKeyUp, this);\r\n\r\n    }\r\n\r\n    _init() {\r\n        this._isFinished = false;\r\n        Constant.FinishedGame = false;\r\n        this._addListener();\r\n    }\r\n\r\n    private _touchStart(event: EventTouch) {\r\n        if(this._isFinished || !Constant.CurMap.physicsStatus)return;\r\n        let touchPos = event.getUILocation();\r\n        let pos = new Vec3(touchPos.x, touchPos.y, 0);\r\n        pos = this.node.parent?.getComponent(UITransform)?.convertToNodeSpaceAR(pos) as Vec3;\r\n        /* 控制点击区域在左下半区 */\r\n        if (pos.x > 0 || pos.y > 0) {\r\n            this._isUseful = false;\r\n            return;\r\n        }\r\n        this._isUseful = true;\r\n        this.joystickBg.setPosition(pos);\r\n    }\r\n\r\n    private _touchMove(event: EventTouch) {\r\n        if (!this._isUseful || !Constant.CurMap.physicsStatus) {\r\n            return;\r\n        }\r\n        let touchPos = event.getUILocation();\r\n        let pos = new Vec3(touchPos.x, touchPos.y, 0);\r\n        pos = this.joystickBg?.getComponent(UITransform)?.convertToNodeSpaceAR(pos) as Vec3;\r\n        pos.x += this._offsetX;\r\n\r\n        pos.x = pos.x+this.node.getPosition().x;\r\n        let radius = Math.atan2(pos.y, pos.x);\r\n        let out = new Vec3();\r\n        let len = Vec3.subtract(out, pos, new Vec3()).length();\r\n        //控制移动范围在摇杆背景圆内\r\n        if (len >= this._R) {\r\n            let xx = Math.cos(radius) * this._R;\r\n            let yy = Math.sin(radius) * this._R;\r\n            this.joystickBar.setPosition(new Vec3(xx, yy, 0));\r\n        }\r\n        else {\r\n            this.joystickBar.setPosition(pos);\r\n        }\r\n        let bPos = this.joystickBar.getPosition();\r\n        clientEvent.dispatchEvent(Constant.EVENT_TYPE.Move, bPos);\r\n    }\r\n\r\n    private _touchEnd(event: EventTouch) {\r\n        if (!this._isUseful || !Constant.CurMap.physicsStatus) return;\r\n        this._isUseful = false;\r\n        this.joystickBg.setPosition(this._originPos);\r\n        this.joystickBar.setPosition(new Vec3());\r\n        clientEvent.dispatchEvent(Constant.EVENT_TYPE.Stop);\r\n    }\r\n    private _onKeyDown(e: EventKeyboard) {\r\n        if(this._isFinished || !Constant.CurMap.physicsStatus)return;\r\n        switch (e.keyCode) {\r\n            case KeyCode.KEY_A:\r\n                clientEvent.dispatchEvent(Constant.EVENT_TYPE.Move, new Vec3(-1, 0, 0));\r\n                break;\r\n            case KeyCode.KEY_D:\r\n                clientEvent.dispatchEvent(Constant.EVENT_TYPE.Move, new Vec3(1, 0, 0));\r\n                break;\r\n            case KeyCode.SPACE:\r\n                this.jump();\r\n                break;\r\n        }\r\n    }\r\n    private _onKeyUp(e: EventKeyboard) {\r\n        if(this._isFinished || !Constant.CurMap.physicsStatus)return;\r\n        switch (e.keyCode) {\r\n            case KeyCode.KEY_A:\r\n                clientEvent.dispatchEvent(Constant.EVENT_TYPE.Stop);\r\n                break;\r\n            case KeyCode.KEY_D:\r\n                clientEvent.dispatchEvent(Constant.EVENT_TYPE.Stop);\r\n                break;\r\n        }\r\n    }\r\n\r\n    private _addListener() {\r\n        clientEvent.on(Constant.EVENT_TYPE.MoveJoystick, this._evtMoveJoystick, this);\r\n        clientEvent.on(Constant.EVENT_TYPE.FinishedGame, this._evtFinishedGame, this);\r\n    }\r\n\r\n    onDestroy() {\r\n        clientEvent.off(Constant.EVENT_TYPE.MoveJoystick, this._evtMoveJoystick, this);\r\n        clientEvent.off(Constant.EVENT_TYPE.FinishedGame, this._evtFinishedGame, this);\r\n    }\r\n\r\n    /**\r\n     * 摇杆跟着摄像机移动\r\n     * @param params \r\n     */\r\n    private _evtMoveJoystick(point:Vec3) {\r\n        let pos = this.node.getPosition();\r\n        pos.x = point.x;\r\n        this.node.setPosition(pos);\r\n    }\r\n\r\n    private jump() {\r\n        if(this._isFinished)return;\r\n        AudioManager.instance.playSound(\"smb_jumpsmall\",false);\r\n        clientEvent.dispatchEvent(Constant.EVENT_TYPE.Jump);\r\n    }\r\n\r\n    private _evtFinishedGame(){\r\n        if(this._isFinished)return;\r\n        this._isFinished = true;\r\n        Constant.FinishedGame = true;\r\n    }\r\n}\r\n\r\n"]}