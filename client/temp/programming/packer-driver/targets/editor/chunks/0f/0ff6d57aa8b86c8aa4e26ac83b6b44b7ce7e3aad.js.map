{"version":3,"sources":["file:///E:/CocosCreator/git/mario/client/assets/script/framework/audioManager.ts"],"names":["_decorator","AudioClip","AudioSource","StorageManager","resourceUtil","ccclass","property","AudioManager","dictWeaponSoundIndex","musicVolume","soundVolume","audios","arrSound","instance","_instance","init","getAudioSetting","onAppShow","name","audio","loop","clip","play","isMusic","state","getGlobalData","playMusic","path","loadRes","err","tmp","as","playSound","push","setLoop","volume","playClip","setVolume","stop","hasOwnProperty","stopAll","i","setMusic","flag","item","pauseAll","console","log","pause","resumeAll","openMusic","setGlobalData","closeMusic","openSound","setSound","closeSound","idx","length","stopSingleSound"],"mappings":"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","sourcesContent":["import { lodash } from './lodash';\r\nimport { _decorator, AudioClip, AudioSource } from \"cc\";\r\nimport { StorageManager } from \"./storageManager\";\r\nimport { resourceUtil } from \"./resourceUtil\";\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass(\"AudioManager\")\r\nexport class AudioManager  {\r\n    static _instance: AudioManager;\r\n    dictWeaponSoundIndex: any = {};\r\n\r\n    static get instance () {\r\n        if (this._instance) {\r\n            return this._instance;\r\n        }\r\n\r\n        this._instance = new AudioManager();\r\n        this._instance.init();\r\n        return this._instance;\r\n    }\r\n\r\n    musicVolume: number = 0.8;\r\n    soundVolume: number = 1;\r\n    audios: any = {};\r\n    arrSound: any = [];\r\n\r\n    init () {\r\n        this.musicVolume = this.getAudioSetting(true) ? 0.8: 0;\r\n        this.soundVolume = this.getAudioSetting(false) ? 1 : 0;\r\n\r\n        // let isPlayAudio = true;\r\n        \r\n        // this.musicVolume = isPlayAudio ? 0.8: 0;\r\n        // this.soundVolume = isPlayAudio ? 1 : 0;\r\n    }\r\n\r\n    onAppShow () {\r\n        for (let name in this.audios) {\r\n            let audio = this.audios[name];\r\n            if (audio.loop) {\r\n                //属于无限循环的，则需要在wx环境下自己开启播放\r\n                audio.clip.play();\r\n            }\r\n        }\r\n    }\r\n\r\n    getAudioSetting (isMusic: boolean) {\r\n        let state;\r\n        if (isMusic) {\r\n            state = StorageManager.instance.getGlobalData('music');\r\n        } else {\r\n            state = StorageManager.instance.getGlobalData('sound');\r\n        }\r\n        return !state || state === 'true' ? true : false;\r\n    }\r\n\r\n    /**\r\n     * 播放音乐\r\n     * @param {String} name 音乐名称可通过constants.AUDIO_MUSIC 获取\r\n     * @param {Boolean} loop 是否循环播放\r\n     */\r\n    playMusic (name:string, loop: boolean) {\r\n        return;\r\n        let path = 'audio/' + name;\r\n        //微信特殊处理，除一开场的音乐，其余的放在子包里头\r\n        // if (name !== 'click') {\r\n        //     path =  path; //微信特殊处理，除一开场的音乐，其余的放在子包里头\r\n        // }\r\n        if(this.audios[name] && this.audios[name].loop){\r\n            return;\r\n        }\r\n         \r\n        resourceUtil.loadRes(path, AudioClip, (err: any, clip: any)=> {\r\n            let tmp = {} as any;\r\n            tmp.clip = clip;\r\n            tmp.loop = loop;\r\n            tmp.isMusic = true;\r\n            this.audios[name] = tmp;\r\n            // this.playClip(name, true); \r\n            let as = new AudioSource();\r\n            as.clip = clip;\r\n            as.loop = loop;\r\n            as.play();\r\n        });     \r\n    }\r\n\r\n    /**\r\n     * 播放音效\r\n     * @param {String} name 音效名称可通过constants.AUDIO_SOUND 获取\r\n     * @param {Boolean} loop 是否循环播放\r\n     */\r\n    playSound (name:string, loop:boolean = false) {\r\n        if (!this.soundVolume) {\r\n            return;\r\n        }\r\n\r\n        //音效一般是多个的，不会只有一个\r\n        let path = 'audio/';\r\n        \r\n        // name = \"smb_coin\";\r\n        resourceUtil.loadRes(path + name, AudioClip, (err: any, clip: any)=> {\r\n            let tmp = {} as any;\r\n            tmp.clip = clip;\r\n            tmp.loop = loop;\r\n            tmp.isMusic = false;\r\n            this.arrSound.push(tmp);\r\n\r\n            if (loop) {\r\n                this.audios[name] = tmp;\r\n                clip.setLoop(loop);\r\n            }\r\n            let as = new AudioSource();\r\n            as.clip = clip;\r\n            as.volume = this.soundVolume;\r\n            as.play();\r\n\r\n            // clip.setVolume(this.soundVolume);\r\n            \r\n            // clip.playOneShot();\r\n\r\n            // clip.once('ended', ()=>{\r\n            //     lodash.remove(this.arrSound, (obj: any)=>{\r\n            //         return obj.clip === tmp.clip;\r\n            //     });\r\n            // })\r\n        });\r\n    }\r\n\r\n    playClip (name: string, isMusic?: boolean) {\r\n        // console.log('playClip: ' + JSON.stringify(this.audios));\r\n        let audio = this.audios[name];\r\n        // if (typeof audio.audioId === \"number\") {\r\n        //     let state = cc.audioEngine.getState(audio.audioId);\r\n        //     if (state === cc.audioEngine.AudioState.PLAYING && audio.loop) return;\r\n        // }\r\n\r\n        let volume = this.musicVolume;\r\n        if (!isMusic) {\r\n            volume = this.soundVolume;\r\n        }\r\n\r\n        let clip = audio.clip as AudioClip;\r\n        clip.setVolume(volume);\r\n        clip.setLoop(audio.loop);\r\n        clip.play();\r\n        // let audioId = cc.audioEngine.play(audio.clip, audio.loop, volume);\r\n        // audio.audioId = audioId;\r\n    }\r\n\r\n    stop (name: any) {\r\n        if (this.audios.hasOwnProperty(name)) {\r\n            let audio = this.audios[name];\r\n            audio.clip.stop();\r\n        }\r\n    }\r\n\r\n    stopAll () {\r\n        for (const i in this.audios) {\r\n            if (this.audios.hasOwnProperty(i)) {\r\n                let audio = this.audios[i];\r\n                audio.clip.stop();\r\n            }\r\n        }\r\n    }\r\n\r\n    setMusic (flag: any) {\r\n        if (typeof flag !== \"number\") {\r\n            flag = flag ? 1 : 0;\r\n        }\r\n\r\n        this.musicVolume = flag;\r\n        for (let item in this.audios) {\r\n            if (this.audios.hasOwnProperty(item) && this.audios[item].isMusic) {\r\n                // this.changeState(item, flag);\r\n                let audio = this.audios[item];\r\n                audio.clip.setVolume(this.musicVolume);\r\n            }\r\n        }\r\n    }\r\n\r\n    //看广告时先将音乐暂停\r\n    pauseAll () {\r\n        console.log(\"pause all music!!!\");\r\n\r\n        for (let item in this.audios) {\r\n            if (this.audios.hasOwnProperty(item)) {\r\n                let audio = this.audios[item];\r\n                audio.clip.pause();\r\n            }\r\n        }\r\n    }\r\n\r\n    resumeAll () {\r\n        for (let item in this.audios) {\r\n            if (this.audios.hasOwnProperty(item)) {\r\n                let audio = this.audios[item];\r\n                audio.clip.play();\r\n            }\r\n        }\r\n    }\r\n\r\n    openMusic () {\r\n        this.setMusic(0.8);\r\n        StorageManager.instance.setGlobalData('music', 'true');\r\n    }\r\n\r\n    closeMusic () {\r\n        this.setMusic(0);\r\n        StorageManager.instance.setGlobalData('music', 'false');\r\n    }\r\n\r\n    openSound () {\r\n        this.setSound(1);\r\n        StorageManager.instance.setGlobalData('sound', 'true');\r\n    }\r\n\r\n    closeSound () {\r\n        this.setSound(0);\r\n        StorageManager.instance.setGlobalData('sound', 'false');\r\n    }\r\n\r\n    setSound (flag: any) {\r\n        this.soundVolume = flag;\r\n        for (let item in this.audios) {\r\n            if (this.audios.hasOwnProperty(item) && !this.audios[item].isMusic) {\r\n                // this.changeState(item, flag);\r\n                let audio = this.audios[item];\r\n                audio.clip.setVolume(this.soundVolume);\r\n            }\r\n        }\r\n\r\n        for (let idx = 0; idx < this.arrSound.length; idx++) {\r\n            let audio = this.arrSound[idx];\r\n            audio.clip.setVolume(this.soundVolume);\r\n        }\r\n    }\r\n\r\n    stopSingleSound (name: string) {\r\n        if (this.audios.hasOwnProperty(name) && !this.audios[name].isMusic) {\r\n            let audio = this.audios[name];\r\n            audio.clip.stop();\r\n        }\r\n    }\r\n}\r\n"]}