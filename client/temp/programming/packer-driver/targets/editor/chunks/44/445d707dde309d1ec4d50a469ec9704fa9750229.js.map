{"version":3,"sources":["file:///E:/CocosCreator/git/mario/client/assets/script/game/roles/roleManager.ts"],"names":["_decorator","instantiate","Vec3","UITransform","cfgLevel","clientEvent","Constant","RoleEnum","resourceUtil","ccclass","property","roleManager","_map","_initRolePos","_initEnemyPos","bigLevel","smallLevel","sonLevel","levelData","levelList","alivePoint","_isNext","mapData","Inst","_instance","initMapDataOnlyOnce","init","map","data","setMapData","addMarioToMap","reLifePos","console","log","loadRole","mario","addEnemyToMap","enemyBlack","name","pos","pre","loadPiecesPriefabRes","node","addChildToMap","setPosition","dispatchEvent","EVENT_TYPE","InitCameraPos","updateAlivePoint","rolePos","posCfg","i","length","x","nextLevel","cfgLevelData","small","key","lv1","Number","lv2","startTranslateScene","TranslateScenes","convertToNodeSpace","getWorldPosition","resPos","getComponent","convertToNodeSpaceAR"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, instantiate, Vec3, UITransform } from 'cc';\r\nimport cfgLevel from '../../config/cfgLevel';\r\nimport { clientEvent } from '../../framework/clientEvent';\r\nimport { Constant } from '../../framework/constant';\r\nimport { RoleEnum } from '../../framework/enum';\r\nimport { resourceUtil } from '../../framework/resourceUtil';\r\nimport { map } from '../ui/map/map';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('roleManager')\r\nexport class roleManager {\r\n    private _map: map;\r\n    private _initRolePos = new Vec3();//角色初始化默认位置\r\n    private _initEnemyPos = new Vec3(1000, 20.5, 0);//角色初始化默认位置\r\n    private static _instance: roleManager;\r\n    public bigLevel:string = \"1\";   //大关卡\r\n    public smallLevel:string = \"1\"; //小关卡\r\n    public sonLevel:number = 0;     //小关卡中的关卡\r\n    public levelData = null;        //当前所在关卡地图数据\r\n    private levelList = [];         //当前小关卡中的不同场景地图列表\r\n    public alivePoint:number = 0;\r\n    private _isNext:Boolean = false;//防止多次切换地图\r\n\r\n    public mapData:any = null;     //当前地图数据，给；一个默认值\r\n    public static get Inst(): roleManager {\r\n        if (!this._instance) {\r\n            this._instance = new roleManager();\r\n            this._instance.initMapDataOnlyOnce();\r\n        }\r\n        return this._instance;\r\n    }\r\n    public init(map: map) {\r\n        this._map = map;\r\n        this._isNext = false;\r\n    }\r\n\r\n    initMapDataOnlyOnce(){\r\n        if(this.mapData) return;\r\n        this.mapData =  cfgLevel.data[\"1\"][\"1\"][0];\r\n        this.setMapData(this.mapData);\r\n    }\r\n\r\n    /**\r\n     * 加载mario到场景地图中\r\n     */\r\n    public addMarioToMap() {\r\n        this.levelList = cfgLevel.data[this.bigLevel][this.smallLevel]\r\n        this.levelData = this.levelList[this.sonLevel];\r\n        // this._initRolePos = this.levelData.reLifePos[this.alivePoint];\r\n        this._initRolePos = this.mapData.reLifePos[this.alivePoint];//出身点\r\n        console.log(this.mapData,this._initRolePos,this.alivePoint);\r\n        this.loadRole(RoleEnum.mario, this._initRolePos);\r\n    }\r\n\r\n    /**\r\n     * 加载monster到场景地图中\r\n     */\r\n    public addEnemyToMap() {\r\n        this.loadRole(RoleEnum.enemyBlack, this._initEnemyPos);\r\n    }\r\n\r\n    /**\r\n     * 动态加载角色\r\n     * @param na0me \r\n     * @param pos \r\n     */\r\n    private async loadRole(name: string, pos: Vec3) {\r\n        let pre = await resourceUtil.loadPiecesPriefabRes(name)\r\n        if (pre) {\r\n            //加载金币并发送消除金币事件\r\n            let node = instantiate(pre) as Node;\r\n            node.name = name;\r\n            this._map.addChildToMap(node);\r\n            // this._map.node.addChild(node);\r\n            node.setPosition(pos);\r\n            clientEvent.dispatchEvent(Constant.EVENT_TYPE.InitCameraPos,this._initRolePos);\r\n        }\r\n    }\r\n\r\n    public updateAlivePoint(rolePos:Vec3){\r\n        let posCfg = this.levelData.reLifePos;\r\n        for(let i = 0 ;i <posCfg.length;i++){\r\n            if(rolePos.x>posCfg[i].x){\r\n                this.alivePoint = i;\r\n            }\r\n        }\r\n    }\r\n\r\n    //切换下一关或隐藏小关卡\r\n    public nextLevel(){\r\n        if(this._isNext)return;\r\n        this._isNext = true;\r\n        let length = this.levelList.length;\r\n        let cfgLevelData = cfgLevel.data;\r\n        let smallLevel = \"no\";\r\n        let bigLevel = \"no\";\r\n        if(this.sonLevel+1 == length){//小关中再无其他地图\r\n            this.sonLevel = 0;\r\n            let small = cfgLevelData[this.bigLevel];\r\n            for(let key in small){\r\n                let lv1 = Number(this.smallLevel);\r\n                let lv2 = Number(key);\r\n                if(lv1 + 1 == lv2){\r\n                   smallLevel = key;//进入下一个小关卡\r\n                   this.smallLevel = key;\r\n                   break;\r\n                }\r\n            }\r\n            if(smallLevel == \"no\"){\r\n                this.smallLevel = \"1\";\r\n                for(let key in cfgLevelData){\r\n                    let lv1 = Number(this.bigLevel);\r\n                    let lv2 = Number(key);\r\n                    if(lv1+1 == lv2){\r\n                        bigLevel = key;\r\n                        this.bigLevel = key;//下一个大关卡\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n            if(bigLevel == \"no\"){\r\n                this.bigLevel = \"1\";//通关了，回到1-1-1\r\n            }\r\n        }\r\n        else{\r\n            this.sonLevel++;\r\n        }\r\n        let mapData = cfgLevel.data[this.bigLevel][this.smallLevel][this.sonLevel];\r\n        this.setMapData(mapData);\r\n        this.startTranslateScene();\r\n    }\r\n\r\n    public setMapData(data){\r\n        if(this.mapData && this.mapData.map != data.map){\r\n            this.alivePoint = 0;\r\n        }\r\n        console.log(this.mapData.map,data.map)\r\n        this.mapData = data;\r\n    }\r\n\r\n    public startTranslateScene(){\r\n        clientEvent.dispatchEvent(Constant.EVENT_TYPE.TranslateScenes);\r\n    }\r\n\r\n\r\n    //转换到节点坐标系\r\n    public convertToNodeSpace(node:Node){\r\n        let pos = node.getWorldPosition();\r\n        let resPos = this._map.node.getComponent(UITransform).convertToNodeSpaceAR(pos);\r\n        return resPos;\r\n    }\r\n}\r\n\r\n"]}