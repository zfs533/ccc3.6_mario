{"version":3,"sources":["file:///D:/CocosDashboard/resources/.editors/Creator/3.6.0/resources/app.asar.unpacked/modules/editor-extensions/extensions/localization-editor/static/assets/core/resource-data-manager.ts"],"names":["ResourceDataManager","assetManager","settings","Settings","BUILD","EDITOR","mainName","pluginName","resourceBundlePath","resourceListPath","runtimeBundleName","readResourceList","Editor","Message","request","console","log","runtimeLoad","previewLoad","readResourceBundle","tags","editorLoad","locales","fileName","bundle","getBundle","undefined","jsonAsset","getResource","json","urlPath","fetch","e","checkBundle","bundleName","queryResult","querySettings","Category","ASSETS","find","it","Promise","resolve","loadBundle","error","resourceName","load","asset"],"mappings":"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","sourcesContent":["// @ts-ignore\nimport { BUILD, EDITOR } from 'cc/env';\nimport { AssetManager, assetManager, JsonAsset, settings, Settings } from 'cc';\nimport { ResourceBundle, ResourceList } from './l10n-options';\nimport { mainName, pluginName, resourceBundlePath, resourceListPath, runtimeBundleName } from './localization-global';\n\nexport default class ResourceDataManager {\n    async readResourceList(): Promise<ResourceList> {\n        if (EDITOR) {\n            return Editor.Message.request(mainName, 'get-resource-list');\n        } else if (BUILD) {\n            console.log(`[${pluginName}] this is build env`);\n            return this.runtimeLoad(resourceListPath);\n        } else {\n            return this.previewLoad(resourceListPath);\n        }\n    }\n\n    async readResourceBundle(tags: Intl.BCP47LanguageTag[]): Promise<ResourceBundle> {\n        if (EDITOR) {\n            return this.editorLoad(tags);\n        } else if (BUILD) {\n            return this.runtimeLoad(resourceBundlePath);\n        } else {\n            return this.previewLoad(resourceBundlePath);\n        }\n    }\n\n    /**\n     * 编辑器模式下使用\n     * @param locales\n     */\n    async editorLoad(locales: Intl.BCP47LanguageTag[]): Promise<ResourceBundle | undefined> {\n        return Editor.Message.request(mainName, 'get-resource-bundle', locales);\n    }\n\n    /**\n     * 构建后运行时使用\n     * @param fileName\n     */\n    async runtimeLoad<T>(fileName: string): Promise<T | undefined> {\n        const bundle = await this.getBundle(runtimeBundleName);\n        if (!bundle) return undefined;\n        const jsonAsset = await this.getResource(bundle, fileName);\n        if (!jsonAsset || !jsonAsset.json) return undefined;\n        return jsonAsset.json as any as T;\n    }\n\n    /**\n     * 浏览器预览使用\n     * @param urlPath\n     */\n    async previewLoad<T>(urlPath: string): Promise<T | undefined> {\n        try {\n            return await (await fetch(`${mainName}/${urlPath}`)).json() as T;\n        } catch (e) {\n            return undefined;\n        }\n    }\n\n    async checkBundle(bundleName: string): Promise<boolean> {\n        const queryResult: { bundle: string, version: string }[] | null = settings.querySettings<{ bundle: string, version: string }[]>(Settings.Category.ASSETS, 'preloadBundles');\n        const bundle = queryResult?.find((it) => it.bundle === bundleName);\n        return !!bundle;\n    }\n\n    async getBundle(bundleName: string): Promise<AssetManager.Bundle | undefined> {\n        return new Promise(resolve => {\n            assetManager.loadBundle(bundleName, (error, bundle: AssetManager.Bundle) => {\n                if (error) {\n                    resolve(undefined);\n                } else {\n                    resolve(bundle);\n                }\n            });\n        });\n    }\n\n    async getResource(bundle: AssetManager.Bundle, resourceName: string): Promise<JsonAsset | undefined> {\n        return new Promise(resolve => {\n            bundle.load(resourceName, (error, asset: JsonAsset) => {\n                if (error) {\n                    resolve(undefined);\n                } else {\n                    resolve(asset);\n                }\n            });\n        });\n    }\n}\n"]}